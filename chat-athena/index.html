<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat IA Revolution - Iframe Dinâmico</title>
    <script>
      const nomeModuloEstatico = 'agente_de_ia_com_n8n';
    </script>
    <link href="https://cdn.jsdelivr.net/npm/@n8n/chat/dist/style.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
      /* ===== VARIÁVEIS CSS CUSTOMIZADAS ===== */
      :root {
        /* --- CORES PRINCIPAIS --- */
        --chat--color-primary: #7C00FF;
        --chat--color-primary-shade-50: #6B00E6;
        --chat--color-primary-shade-100: #5A00CC;
        --chat--color-secondary: #7C00FF;
        --chat--color-secondary-shade-50: #6B00E6;
        --chat--color-dark: #7C00FF;
        --chat--color-light: #232323;
        --chat--color-white: #232323;
        --chat--color-light-shade-50: #2a2a2a;
        --chat--color-light-shade-100: none;
        --chat--color-medium: #404040;
        --chat--color-disabled: #777980;
        --chat--color-typing: #ffffff;
        /* --- LAYOUT E DIMENSÕES --- */
        --chat--border-radius: 16px;
        --chat--window--width: 420px;
        --chat--window--height: 560px;
        --chat--window--border: none;
        /* --- CONFIGURAÇÕES DE FONTE --- */
        --chat--font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen-Sans, Ubuntu, Cantarell, 'Helvetica Neue', sans-serif;
        /* --- HEADER (CABEÇALHO) --- */
        --chat--header--background: #7C00FF;
        --chat--header--color: #ffffff;
        --chat--header--padding: 1.2rem;
        --chat--heading--font-size: 2em;
        --chat--subtitle--font-size: 0.9em;
        --chat--subtitle--line-height: 1.2;
        /* --- MENSAGENS --- */
        --chat--message--bot--background: #333333;
        --chat--message--bot--color: #ffffff;
        --chat--message--bot--border: none;
        --chat--message--user--background: #535353;
        --chat--message--user--color: #ffffff;
        --chat--message--user--border: none;
        --chat--message--pre--background: rgba(255, 255, 255, 0.1);
        --chat--messages-list--padding: 1rem;
        --chat--message--font-size: 1rem;
        --chat--message--padding: 1rem;
        --chat--message--border-radius: 16px;
        --chat--message-line-height: 1.5;
        --chat--message--margin-bottom: 1rem;
        /* --- ÁREA DE INPUT (DIGITAÇÃO) --- */
        --chat--textarea--height: 50px;
        --chat--textarea--max-height: 30rem;
        --chat--input--font-size: inherit;
        --chat--input--border: 0;
        --chat--input--border-radius: 0;
        --chat--input--padding: 0.8rem;
        --chat--input--background: #232323;
        --chat--input--text-color: #ffffff;
        --chat--input--line-height: 1.5;
        --chat--input--placeholder--font-size: inherit;
        --chat--input--border-active: 0;
        --chat--input--left--panel--width: 2rem;
        /* --- BOTÕES GERAIS --- */
        --chat--button--color: #ffffff;
        --chat--button--background: #7C00FF;
        --chat--button--padding: 0.5rem 1rem;
        --chat--button--border-radius: 16px;
        --chat--button--hover--color: #ffffff;
        --chat--button--hover--background: #6B00E6;
        --chat--close--button--color-hover: #7C00FF;
        /* --- BOTÃO TOGGLE (ABRIR/FECHAR CHAT) --- */
        --chat--toggle--size: 64px;
        --chat--toggle--width: var(--chat--toggle--size);
        --chat--toggle--height: var(--chat--toggle--size);
        --chat--toggle--border-radius: 50%;
        --chat--toggle--background: #7C00FF;
        --chat--toggle--hover--background: #6B00E6;
        --chat--toggle--active--background: #5A00CC;
        --chat--toggle--color: #ffffff;
        /* --- BOTÕES DE ENVIO E ARQUIVO --- */
        --chat--input--send--button--background: #232323;
        --chat--input--send--button--color: #ffffff;
        --chat--input--send--button--background-hover: #7C00FF;
        --chat--input--send--button--color-hover: #ffffff;
        --chat--input--file--button--background: #232323;
        --chat--input--file--button--color: #7C00FF;
        --chat--input--file--button--background-hover: #333333;
        --chat--input--file--button--color-hover: #6B00E6;
        --chat--files-spacing: 0.25rem;
        /* --- CORPO E RODAPÉ --- */
        --chat--body--background: #232323;
        --chat--footer--background: #232323;
        --chat--footer--color: #ffffff;
      }

      /* ===== CONTAINER DINÂMICO PARA IFRAME ===== */
      body {
        margin: 0;
        padding: 0;
        min-width: 180px;
        min-height: 64px;
        overflow: visible;
        background: transparent;
        position: relative;
      }

      #iarev-chat {
        position: relative;
        min-width: 180px;
        min-height: 64px;
      }

      .chat {
        position: relative !important;
      }

      .chat__window {
        position: fixed !important;
        bottom: 0 !important;
        right: 0 !important;
        z-index: 9999 !important;
      }

      .chat__toggle {
        position: fixed !important;
        bottom: 0 !important;
        right: 0 !important;
        z-index: 10000 !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        width: auto !important;
        min-width: 180px !important;
        border-radius: 30px !important;
        padding: 0 20px !important;
        font-family: 'Poppins', sans-serif !important;
      }

      .chat__toggle svg {
        display: inline-block !important;
        margin-right: 10px !important;
        width: 24px !important;
        height: 24px !important;
      }

      .chat__toggle::after {
        content: "Tire Dúvidas com IA";
        display: inline-block;
        color: white;
        font-size: 14px;
        font-weight: 500;
        font-family: 'Poppins', sans-serif !important;
      }

      /* ===== ELEMENTOS OCULTOS ===== */
      .chat__welcome-screen-button,
      .chat__footer > span,
      .chat__footer span,
      span.svelte-15j5n1q {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
        height: 0 !important;
        font-size: 0 !important;
      }

      .chat__footer:empty {
        height: 0 !important;
        padding: 0 !important;
        margin: 0 !important;
      }

      .chat__footer {
        position: relative !important;
      }

      .chat__footer > * {
        position: absolute !important;
        left: -9999px !important;
        opacity: 0 !important;
      }

      /* ===== CUSTOMIZAÇÕES DE FONTES ===== */
      .chat-header h1, .chat-header h2, .chat-header h3, .chat-title, h1, h2, h3, h4, h5, h6 {
        font-family: 'Montserrat', sans-serif !important;
        color: #ffffff !important;
        font-weight: 600;
        margin-bottom: 0.1em !important;
        margin-top: 0 !important;
      }

      .chat-header h1, .chat-title {
        font-weight: 600 !important;
        line-height: 1.1 !important;
      }

      .chat-header p, .chat-subtitle {
        font-family: 'Montserrat', sans-serif !important;
        font-weight: 600 !important;
        color: #ffffff !important;
        margin-top: 0 !important;
        margin-bottom: 0.5em !important;
      }

      .chat-message, .chat-input, .chat-body, p, span, div, input, textarea {
        font-family: 'Poppins', sans-serif !important;
        color: #ffffff !important;
      }

      input::placeholder, textarea::placeholder {
        color: #999999 !important;
        opacity: 1;
      }

      .chat-message {
        max-width: 80% !important;
        color: #ffffff !important;
      }

      .chat-message--bot, .chat__message--bot {
        max-width: 80% !important;
      }

      ::-webkit-scrollbar {
        width: 8px;
      }
      ::-webkit-scrollbar-track {
        background: #232323;
      }
      ::-webkit-scrollbar-thumb {
        background: #7C00FF;
        border-radius: 6px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #6B00E6;
      }
    </style>
</head>
<body>
    <div id="iarev-chat"></div>
    <script type="module">
      import { createChat } from "https://cdn.jsdelivr.net/npm/@n8n/chat/dist/chat.bundle.es.js";

      if (window.__iarevChat) {
        window.__iarevChat.destroy?.();
      }

      /* =======================================
         SISTEMA DE COMUNICAÇÃO UNIVERSAL
       ======================================= */
      let currentState = 'closed';

      function broadcastToParent(width, height, isOpen) {
        // Ajusta o próprio iframe
        document.body.style.width = width + 'px';
        document.body.style.height = height + 'px';
        document.body.style.overflow = isOpen ? 'visible' : 'hidden';

        const message = {
          type: 'chatResize',
          width: width,
          height: height,
          isOpen: isOpen,
          timestamp: Date.now(),
          source: 'iarev-chat'
        };

        // MÉTODO 1: PostMessage normal
        if (window.parent && window.parent !== window) {
          window.parent.postMessage(message, '*');
        }

        // MÉTODO 2: PostMessage para top
        if (window.top && window.top !== window) {
          window.top.postMessage(message, '*');
        }

        // MÉTODO 3: PostMessage para todos os parents possíveis
        let currentWindow = window;
        let attempts = 0;
        while (currentWindow.parent && currentWindow.parent !== currentWindow && attempts < 10) {
          try {
            currentWindow.parent.postMessage(message, '*');
            currentWindow = currentWindow.parent;
            attempts++;
          } catch (e) {
            break;
          }
        }

        // MÉTODO 4: Evento personalizado
        try {
          const event = new CustomEvent('iframeResize', { 
            detail: message 
          });
          document.dispatchEvent(event);
          window.dispatchEvent(event);
        } catch (e) {}

        // MÉTODO 5: Callback global (se existir)
        if (window.iframeChatResize) {
          window.iframeChatResize(width, height, isOpen);
        }

        console.log(`📢 BROADCAST: ${isOpen ? 'ABERTO' : 'FECHADO'} | ${width}x${height}px`);
        currentState = isOpen ? 'open' : 'closed';
      }

      function detectChatState() {
        // Verifica se existe a janela do chat (como visto no DevTools)
        const chatWindow = document.querySelector('.chat-window');
        const chatLayout = document.querySelector('.chat-layout');
        const chatContainer = document.getElementById('iarev-chat');
        
        let isOpen = false;

        // MÉTODO 1: Verifica elementos específicos do chat
        if (chatWindow && chatWindow.offsetHeight > 0 && chatWindow.offsetWidth > 0) {
          const style = getComputedStyle(chatWindow);
          if (style.display !== 'none' && style.visibility !== 'hidden' && style.opacity !== '0') {
            isOpen = true;
          }
        }

        // MÉTODO 2: Verifica se o layout do chat está ativo
        if (!isOpen && chatLayout && chatLayout.offsetHeight > 100) {
          isOpen = true;
        }

        // MÉTODO 3: Verifica se o container cresceu significativamente
        if (!isOpen && chatContainer && chatContainer.offsetHeight > 100) {
          isOpen = true;
        }

        // MÉTODO 4: Conta elementos visíveis do chat
        const chatElements = document.querySelectorAll('[class*="chat-"]:not(.chat__toggle)');
        let visibleElements = 0;
        chatElements.forEach(el => {
          if (el.offsetHeight > 0 && el.offsetWidth > 0) {
            const style = getComputedStyle(el);
            if (style.display !== 'none' && style.visibility !== 'hidden') {
              visibleElements++;
            }
          }
        });

        if (!isOpen && visibleElements > 3) {
          isOpen = true;
        }

        // Só notifica se houve mudança de estado
        const newState = isOpen ? 'open' : 'closed';
               if (newState !== currentState) {
          if (isOpen) {
            broadcastToParent(480, 620, true);
          } else {
            broadcastToParent(220, 84, false);
          }
        }
      }

      /* =======================================
         CONFIGURAÇÃO DE METADADOS
       ======================================= */
      const metadata = {
        modulo: nomeModuloEstatico,
        aula: "aula_geral",
      };
      
      // =========================================================================================
      // ALTERAÇÃO PRINCIPAL: Substituição do listener antigo pelo novo, mais robusto e flexível.
      // =========================================================================================
      
      /**
       * NOVO: Envia o "sinal" de que o chat está pronto (handshake).
       * Isso é crucial para que a página da Cademí saiba quando enviar o nome da aula.
       */
      function notifyParentReady() {
        console.log('IFRAME: 🚀 Chat pronto! Notificando a página principal.');
        if (window.parent && window.parent !== window) {
            window.parent.postMessage({ type: 'chatReady' }, '*');
        }
      }

      /**
       * NOVO E CORRIGIDO: Listener de mensagens unificado e com verificação de origem flexível.
       * Ele substitui o seu listener antigo.
       */
      window.addEventListener('message', function(event) {
        // Permite mensagens de qualquer subdomínio de iarevolution.com.br
        const allowedOriginPattern = /^(https:\/\/([a-z0-9-]+\.)?iarevolution\.com\.br)$/;
        if (!allowedOriginPattern.test(event.origin)) {
            // Silenciosamente ignora mensagens de origens não permitidas para segurança
            return;
        }

        const data = event.data;
        // Verifica se a mensagem é do tipo 'setAula' para atualizar os metadados
        if (data && data.type === 'setAula') {
          console.log('IFRAME: 📨 Mensagem de aula recebida:', data);
          const nomeAula = data.aula ? data.aula.trim() : 'aula_geral';
          if (metadata.aula !== nomeAula) {
            metadata.aula = nomeAula;
            console.log('IFRAME: ✅ Metadados da aula atualizados para:', nomeAula);
          }
        }
      });

      /* =======================================
         FUNÇÃO PARA REMOVER "Powered by n8n"
       ======================================= */
      function removePoweredByN8n() {
        const footerElements = document.querySelectorAll('.chat__footer span, .chat__footer > span, span.svelte-15j5n1q');
        footerElements.forEach(el => {
          if (el.textContent.includes('Powered by') || el.textContent.includes('n8n')) {
            el.remove();
          }
        });

        const walker = document.createTreeWalker(
          document.getElementById('iarev-chat'),
          NodeFilter.SHOW_TEXT,
          null,
          false
        );
        let node;
        const nodesToRemove = [];
        while (node = walker.nextNode()) {
          if (node.textContent.includes('Powered by n8n')) {
            nodesToRemove.push(node.parentElement);
          }
        }
        nodesToRemove.forEach(el => {
          if (el) el.remove();
        });

        const footer = document.querySelector('.chat__footer');
        if (footer && footer.textContent.includes('Powered by')) {
          footer.innerHTML = '';
          footer.style.display = 'none';
        }
      }

      /* =======================================
         CRIAÇÃO E CONFIGURAÇÃO DO CHAT
       ======================================= */
      window.__iarevChat = createChat({
        target: "#iarev-chat",
        webhookUrl: "/api/chat-proxy",
        metadata,
        showWelcomeScreen: false,
        initialMessages: [
            "Olá! Sou a Athena, monitora do IA Revolution. Me fala qual é sua pergunta sobre essa aula, que vou te ajudar 😄"
        ],
        i18n: {
          en: {
            title: 'Athena IA 🧠',
            subtitle: "Sua Monitora do IA Revolution!",
            inputPlaceholder: "Digite sua dúvida aqui…",
          }
        }
      });

      /* =======================================
         MONITORAMENTO AGRESSIVO
       ======================================= */
      function setupMonitoring() {
        console.log('🚀 Iniciando monitoramento agressivo...');

        // Observer principal no container
        const chatContainer = document.getElementById('iarev-chat');
        if (chatContainer) {
          const observer = new MutationObserver(() => {
            setTimeout(detectChatState, 50);
          });

          observer.observe(chatContainer, {
            childList: true,
            subtree: true,
            attributes: true,
            attributeFilter: ['style', 'class', 'data-state']
          });

          // ResizeObserver para mudanças de tamanho
          const resizeObserver = new ResizeObserver(() => {
            setTimeout(detectChatState, 50);
          });
          resizeObserver.observe(chatContainer);
        }

        // Monitora especificamente o toggle
        const monitorToggle = () => {
          const toggle = document.querySelector('.chat__toggle');
          if (toggle && !toggle.hasAttribute('data-monitored')) {
            toggle.setAttribute('data-monitored', 'true');
            console.log('🎯 Toggle configurado');

            toggle.addEventListener('click', () => {
              console.log('🖱️ Toggle clicado');
              
              // Sequência agressiva de verificações
              [100, 200, 300, 500, 800, 1000, 1500, 2000].forEach(delay => {
                setTimeout(() => {
                  detectChatState();
                  console.log(`⏱️ Verificação ${delay}ms`);
                }, delay);
              });
            });
          }
        };

        // Monitora aparição de novos elementos
        const globalObserver = new MutationObserver((mutations) => {
          mutations.forEach(mutation => {
            if (mutation.addedNodes.length > 0) {
              setTimeout(detectChatState, 100);
              setTimeout(monitorToggle, 100);
            }
          });
        });

        globalObserver.observe(document.body, {
          childList: true,
          subtree: true
        });

        // Executa verificações periódicas
        setInterval(detectChatState, 1000);
        setInterval(monitorToggle, 500);
      }

      /* =======================================
         INICIALIZAÇÃO
       ======================================= */
      setTimeout(() => {
        setupMonitoring();
        
        // Remove "Powered by n8n"
        removePoweredByN8n();
        setTimeout(removePoweredByN8n, 1000);
        setTimeout(removePoweredByN8n, 3000);

        // Estado inicial
        setTimeout(() => {
          broadcastToParent(220, 84, false);
        }, 1000);

        // ==========================================================
        // ALTERAÇÃO: Chama a função para notificar que está pronto.
        // ==========================================================
        notifyParentReady();

      }, 1000);

      /* =======================================
         PREVENÇÃO DE MENSAGENS VAZIAS
       ======================================= */
      setTimeout(() => {
        const chatContainer = document.getElementById('iarev-chat');
        if (chatContainer) {
          chatContainer.addEventListener('click', function(e) {
            const sendButton = e.target.closest('[data-testid="send-button"], .chat__input-send-button, button.svelte-1omdpz4');
            if (sendButton) {
              const input = chatContainer.querySelector('input.svelte-1omdpz4, textarea.svelte-1omdpz4');
              if (input && !input.value.trim()) {
                e.preventDefault();
                e.stopPropagation();
                console.warn('Mensagem vazia bloqueada');
                return false;
              }
            }
          }, true);

          chatContainer.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
              const input = e.target;
              if (input && (input.tagName === 'INPUT' || input.tagName === 'TEXTAREA') && !input.value.trim()) {
                e.preventDefault();
                e.stopPropagation();
                console.warn('Mensagem vazia bloqueada');
                return false;
              }
            }
          }, true);
        }
      }, 1500);

      // DEBUG: Log do estado a cada 5 segundos
      setInterval(() => {
        const chatWindow = document.querySelector('.chat-window');
        const chatLayout = document.querySelector('.chat-layout');
        console.log(`🔍 Estado atual: 
          - Chat Window: ${chatWindow ? 'SIM' : 'NÃO'} (${chatWindow ? chatWindow.offsetHeight + 'px' : '0px'})
          - Chat Layout: ${chatLayout ? 'SIM' : 'NÃO'} (${chatLayout ? chatLayout.offsetHeight + 'px' : '0px'})
          - Estado: ${currentState}`);
      }, 5000);
    </script>
</body>
</html>
