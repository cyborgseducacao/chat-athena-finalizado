<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat IA Revolution - Iframe Din√¢mico</title>
    <script>
      const nomeModuloEstatico = 'agente_de_ia_com_n8n';
    </script>
    <link href="https://cdn.jsdelivr.net/npm/@n8n/chat/dist/style.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
      /* ===== VARI√ÅVEIS CSS CUSTOMIZADAS ===== */
      :root {
        --chat--color-primary: #7C00FF;
        --chat--color-primary-shade-50: #6B00E6;
        --chat--color-primary-shade-100: #5A00CC;
        --chat--color-secondary: #7C00FF;
        --chat--color-secondary-shade-50: #6B00E6;
        --chat--color-dark: #7C00FF;
        --chat--color-light: #232323;
        --chat--color-white: #232323;
        --chat--color-light-shade-50: #2a2a2a;
        --chat--color-light-shade-100: none;
        --chat--color-medium: #404040;
        --chat--color-disabled: #777980;
        --chat--color-typing: #ffffff;
        --chat--border-radius: 16px;
        --chat--window--width: 420px;
        --chat--window--height: 560px;
        --chat--window--border: none;
        --chat--font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen-Sans, Ubuntu, Cantarell, 'Helvetica Neue', sans-serif;
        --chat--header--background: #7C00FF;
        --chat--header--color: #ffffff;
        --chat--header--padding: 1.2rem;
        --chat--heading--font-size: 2em;
        --chat--subtitle--font-size: 0.9em;
        --chat--subtitle--line-height: 1.2;
        --chat--message--bot--background: #333333;
        --chat--message--bot--color: #ffffff;
        --chat--message--bot--border: none;
        --chat--message--user--background: #535353;
        --chat--message--user--color: #ffffff;
        --chat--message--user--border: none;
        --chat--message--pre--background: rgba(255, 255, 255, 0.1);
        --chat--messages-list--padding: 1rem;
        --chat--message--font-size: 1rem;
        --chat--message--padding: 1rem;
        --chat--message--border-radius: 16px;
        --chat--message-line-height: 1.5;
        --chat--message--margin-bottom: 1rem;
        --chat--textarea--height: 50px;
        --chat--textarea--max-height: 30rem;
        --chat--input--font-size: inherit;
        --chat--input--border: 0;
        --chat--input--border-radius: 0;
        --chat--input--padding: 0.8rem;
        --chat--input--background: #232323;
        --chat--input--text-color: #ffffff;
        --chat--input--line-height: 1.5;
        --chat--input--placeholder--font-size: inherit;
        --chat--input--border-active: 0;
        --chat--input--left--panel--width: 2rem;
        --chat--button--color: #ffffff;
        --chat--button--background: #7C00FF;
        --chat--button--padding: 0.5rem 1rem;
        --chat--button--border-radius: 16px;
        --chat--button--hover--color: #ffffff;
        --chat--button--hover--background: #6B00E6;
        --chat--close--button--color-hover: #7C00FF;
        --chat--toggle--size: 64px;
        --chat--toggle--width: var(--chat--toggle--size);
        --chat--toggle--height: var(--chat--toggle--size);
        --chat--toggle--border-radius: 50%;
        --chat--toggle--background: #7C00FF;
        --chat--toggle--hover--background: #6B00E6;
        --chat--toggle--active--background: #5A00CC;
        --chat--toggle--color: #ffffff;
        --chat--input--send--button--background: #232323;
        --chat--input--send--button--color: #ffffff;
        --chat--input--send--button--background-hover: #7C00FF;
        --chat--input--send--button--color-hover: #ffffff;
        --chat--input--file--button--background: #232323;
        --chat--input--file--button--color: #7C00FF;
        --chat--input--file--button--background-hover: #333333;
        --chat--input--file--button--color-hover: #6B00E6;
        --chat--files-spacing: 0.25rem;
        --chat--body--background: #232323;
        --chat--footer--background: #232323;
        --chat--footer--color: #ffffff;
      }
      /* ===== ESTILOS DO CONTAINER E ELEMENTOS ===== */
      body { margin: 0; padding: 0; min-width: 180px; min-height: 64px; overflow: visible; background: transparent; position: relative; }
      #iarev-chat { position: relative; min-width: 180px; min-height: 64px; }
      .chat { position: relative !important; }
      .chat__window { position: fixed !important; bottom: 0 !important; right: 0 !important; z-index: 9999 !important; }
      .chat__toggle { position: fixed !important; bottom: 0 !important; right: 0 !important; z-index: 10000 !important; display: flex !important; align-items: center !important; justify-content: center !important; width: auto !important; min-width: 180px !important; border-radius: 30px !important; padding: 0 20px !important; font-family: 'Poppins', sans-serif !important; }
      .chat__toggle svg { display: inline-block !important; margin-right: 10px !important; width: 24px !important; height: 24px !important; }
      .chat__toggle::after { content: "Tire D√∫vidas com IA"; display: inline-block; color: white; font-size: 14px; font-weight: 500; font-family: 'Poppins', sans-serif !important; }
      .chat__welcome-screen-button, .chat__footer > span, .chat__footer span, span.svelte-15j5n1q { display: none !important; visibility: hidden !important; opacity: 0 !important; height: 0 !important; font-size: 0 !important; }
      .chat__footer:empty, .chat__footer { height: 0 !important; padding: 0 !important; margin: 0 !important; display: none !important; }
      .chat-header h1, .chat-title { font-family: 'Montserrat', sans-serif !important; color: #ffffff !important; font-weight: 600 !important; line-height: 1.1 !important; margin-bottom: 0.1em !important; margin-top: 0 !important; }
      .chat-header p, .chat-subtitle { font-family: 'Montserrat', sans-serif !important; font-weight: 600 !important; color: #ffffff !important; margin-top: 0 !important; margin-bottom: 0.5em !important; }
      .chat-message, .chat-input, .chat-body, p, span, div, input, textarea { font-family: 'Poppins', sans-serif !important; color: #ffffff !important; }
      input::placeholder, textarea::placeholder { color: #999999 !important; opacity: 1; }
      .chat-message, .chat-message--bot, .chat__message--bot { max-width: 80% !important; }
      ::-webkit-scrollbar { width: 8px; }
      ::-webkit-scrollbar-track { background: #232323; }
      ::-webkit-scrollbar-thumb { background: #7C00FF; border-radius: 6px; }
      ::-webkit-scrollbar-thumb:hover { background: #6B00E6; }
    </style>
</head>
<body>
    <div id="iarev-chat"></div>
    
    <script type="module">
      import { createChat } from "https://cdn.jsdelivr.net/npm/@n8n/chat/dist/chat.bundle.es.js";

      // --- CONFIGURA√á√ÉO E METADADOS ---
      const metadata = {
        modulo: nomeModuloEstatico,
        aula: "aula_geral", // Valor padr√£o
      };
      let currentState = 'closed';

      // --- SISTEMA DE COMUNICA√á√ÉO COM A P√ÅGINA PAI ---

      function postToParent(message) {
        if (window.parent && window.parent !== window) {
          window.parent.postMessage(message, '*');
        }
      }

      function notifyParentReady() {
        console.log('IFRAME: üöÄ Chat pronto! Notificando a p√°gina principal.');
        postToParent({ type: 'chatReady' });
      }

      // Esta fun√ß√£o recebe o nome da aula da plataforma Cadem√≠
      window.addEventListener('message', function(event) {
        const allowedOriginPattern = /^(https:\/\/([a-z0-9-]+\.)?iarevolution\.com\.br)$/;
        if (!allowedOriginPattern.test(event.origin)) {
            return;
        }

        const data = event.data;
        if (data && data.type === 'setAula') {
          console.log('IFRAME: üì® Mensagem de aula recebida:', data);
          const nomeAula = data.aula ? data.aula.trim() : 'aula_geral';
          if (metadata.aula !== nomeAula) {
            metadata.aula = nomeAula;
            console.log('IFRAME: ‚úÖ Metadados da aula atualizados para:', nomeAula);
          }
        }
      });
      
      // --- L√ìGICA DO CHAT ---

      let chatWindowObserver = null;
      function detectChatState() {
        const chatWindow = document.querySelector('.chat__window');
        const isOpen = chatWindow && getComputedStyle(chatWindow).display !== 'none' && chatWindow.offsetHeight > 100;
        const newState = isOpen ? 'open' : 'closed';
        
        if (newState !== currentState) {
          currentState = newState;
          console.log(`IFRAME: üì¢ Estado mudou para ${newState}. Enviando redimensionamento.`);
          const size = isOpen ? { w: 420, h: 580 } : { w: 220, h: 84 };
          postToParent({ type: 'chatResize', width: size.w, height: size.h, isOpen: isOpen });
        }
      }

      function setupMonitoring() {
        const chatContainer = document.getElementById('iarev-chat');
        if (!chatContainer) return;
        
        chatWindowObserver = new MutationObserver(detectChatState);
        chatWindowObserver.observe(chatContainer, {
          childList: true, 
          subtree: true, 
          attributes: true, 
          attributeFilter: ['style', 'class']
        });
      }

      function removePoweredByN8n() {
        document.querySelectorAll('.chat__footer, .chat__footer span').forEach(el => el.style.display = 'none');
      }

      // --- INICIALIZA√á√ÉO ---
      
      if (window.__iarevChat) {
        window.__iarevChat.destroy?.();
      }

      window.__iarevChat = createChat({
        target: "#iarev-chat",
        webhookUrl: "/api/chat-proxy",
        metadata,
        showWelcomeScreen: false,
        initialMessages: [
            "Ol√°! Sou a Athena, monitora do IA Revolution. Qual sua d√∫vida sobre esta aula?"
        ],
        i18n: {
          en: {
            title: 'Athena IA üß†',
            subtitle: "Sua Monitora do IA Revolution!",
            inputPlaceholder: "Digite sua d√∫vida aqui‚Ä¶",
          }
        }
      });

      // Roda a configura√ß√£o p√≥s-cria√ß√£o do chat
      setTimeout(() => {
        setupMonitoring();
        removePoweredByN8n(); // Tenta remover o rodap√© repetidamente
        setInterval(removePoweredByN8n, 1000);

        // Define o estado inicial (fechado)
        postToParent({ type: 'chatResize', width: 220, height: 84, isOpen: false });

        // AVISA √Ä P√ÅGINA PAI QUE EST√Å TUDO PRONTO!
        notifyParentReady();
      }, 500); // Um pequeno delay para garantir que todos os elementos do chat foram renderizados.

    </script>
</body>
</html>
